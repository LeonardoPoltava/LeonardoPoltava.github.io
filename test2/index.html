<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0">
    <title>Главная страница</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
  </head>
  <body>
    <!--<canvas id="canvas"></canvas>-->
    <!--<script src="js/three.min.js"></script>-->
    <!--<script src="js/dat.gui.min.js"></script>-->
    <!--<script src="js/main.js"></script>-->

    <script type="module">

        import * as THREE from './js/three.module.js';
        import { FBXLoader } from './js/FBXLoader.js';

        var container, controls;
        var camera, scene, renderer, light, group, cameraTarget, plane1;

        var mixer;
        let winWidth = window.innerWidth;
        let winHeight = window.innerHeight;
        let targetRotation = 0;
        let targetRotationOnMouseDown = 0;
        let mouseX = 0;
        let mouseXOnMouseDown = 0;
        let windowHalfX = winWidth / 2;
        init();
        animate();

        function init() {
            container = document.createElement( 'div' );
            document.body.appendChild( container );

            camera = new THREE.PerspectiveCamera( 35, winWidth / winHeight, 1, 2000 );
            camera.position.set( 500, 100, 400 );
            cameraTarget = new THREE.Vector3( 0, 100, 0 );
            scene = new THREE.Scene();

            light = new THREE.HemisphereLight( 0xffffff, 0x444444 );
            light.position.set( 0, 200, 0 );
            scene.add( light );

            group = new THREE.Group();
            group.position.y = 0;
            scene.add( group );
            // EVENTS
            document.addEventListener( 'mousedown', onDocumentMouseDown, false );
            document.addEventListener( 'touchstart', onDocumentTouchStart, false );
            document.addEventListener( 'touchmove', onDocumentTouchMove, false );
              function onDocumentMouseDown( event ) {
                event.preventDefault();
                document.addEventListener( 'mousemove', onDocumentMouseMove, false );
                document.addEventListener( 'mouseup', onDocumentMouseUp, false );
                document.addEventListener( 'mouseout', onDocumentMouseOut, false );
                mouseXOnMouseDown = event.clientX - windowHalfX;
                targetRotationOnMouseDown = targetRotation;
            }
            function onDocumentMouseMove( event ) {
                mouseX = event.clientX - windowHalfX;
                targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.02;
            }
            function onDocumentMouseUp() {
                document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
                document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
                document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
            }
            function onDocumentMouseOut() {
                document.removeEventListener( 'mousemove', onDocumentMouseMove, false );
                document.removeEventListener( 'mouseup', onDocumentMouseUp, false );
                document.removeEventListener( 'mouseout', onDocumentMouseOut, false );
            }
            function onDocumentTouchStart( event ) {
                if ( event.touches.length == 1 ) {
                    event.preventDefault();
                    mouseXOnMouseDown = event.touches[ 0 ].pageX - windowHalfX;
                    targetRotationOnMouseDown = targetRotation;
                }
            }
            function onDocumentTouchMove( event ) {
                if ( event.touches.length == 1 ) {
                    event.preventDefault();
                    mouseX = event.touches[ 0 ].pageX - windowHalfX;
                    targetRotation = targetRotationOnMouseDown + ( mouseX - mouseXOnMouseDown ) * 0.05;
                }
            }
            let carTextureF = new THREE.TextureLoader().load( './images/car1.jpg' );
            let carTextureS = new THREE.TextureLoader().load( './images/car2.jpg' );
            let plane = new THREE.Mesh(
                new THREE.PlaneBufferGeometry( 880, 705),
                new THREE.MeshBasicMaterial( { map: carTextureS, opacity: 1, transparent: true } )
            );
            plane.position.set(0,386,-700);
            plane1 = new THREE.Mesh(
                new THREE.PlaneBufferGeometry( 1200, 900),
                new THREE.MeshBasicMaterial( { map: carTextureF, opacity: 1, transparent: true } )
            );
            plane.position.set(-116,340, -404);
            plane1.position.set(-755, 408, -20);
            plane1.rotateY(1.7);
            scene.add(plane);
            scene.add(plane1);

            light = new THREE.DirectionalLight( 0xffffff );
            light.position.set( 0, 200, 100 );
            light.castShadow = true;
            light.shadow.camera.top = 180;
            light.shadow.camera.bottom = - 100;
            light.shadow.camera.left = - 120;
            light.shadow.camera.right = 120;
            scene.add( light );
            // ground
            let asphalt = new THREE.TextureLoader().load( './images/asphalt1.png' );
            let mesh;
            let ground;
            ground = new THREE.Group();
            ground.position.y = -50;
            ground.position.x = 0;
            scene.add( ground );
            ground.rotation.x = - Math.PI / 2;
            function getRandomArbitrary(min, max) {
                return Math.random() * (max - min) + min;
            }
            for(let i=0;i<5;i++) {
                mesh = new THREE.Mesh( new THREE.PlaneBufferGeometry( 2000, 2000), new THREE.MeshBasicMaterial( { map: asphalt } ) );
                mesh.position.set(getRandomArbitrary(-300, 300),getRandomArbitrary(-500, 500), 0);
                ground.add( mesh );
            }
            var loader = new FBXLoader();
            loader.load( 'models/Tesla Model S.fbx', function ( object ) {
                group.add( object );
            }, undefined, function ( error ) {
                console.error( error );
            } );
            renderer = new THREE.WebGLRenderer( { antialias: true } );
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( window.innerWidth, window.innerHeight );
            renderer.shadowMap.enabled = true;
            container.appendChild( renderer.domElement );
            window.addEventListener( 'resize', onWindowResize, false );
        }
        function onWindowResize() {
            camera.aspect = winWidth / winHeight;
            camera.updateProjectionMatrix();
            renderer.setSize( winWidth, winHeight );
        }
        function animate() {

            requestAnimationFrame( animate );

            if ( mixer ) mixer.update( delta );

            renderer.render( scene, camera );
            group.rotation.y += ( targetRotation - group.rotation.y ) * 0.05;
            camera.lookAt( cameraTarget );
        }

    </script>
  </body>
</html>